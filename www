<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blend - AI Image Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --pro-color: #6366F1; }
        body { font-family: 'Inter', sans-serif; background-color: #F8F7F4; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        body.dark { background-color: #121212; }
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: center; max-width: 500px; background-color: #FDFDFC; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); position: relative; overflow: hidden; }
        .dark .app-container { background-color: #1E1E1E; color: #FDFDFC; }
        .top-bar { width: 100%; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; z-index: 20; position: absolute; top: 0; }
        .logo { font-size: 1.5rem; font-weight: 700; letter-spacing: -1px; }
        .main-content { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; padding: 16px; position: relative; margin-top: 4rem; min-height: 0; }
        .image-container { width: 100%; height: 100%; background-color: #EFEFEF; border-radius: 20px; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .dark .image-container { background-color: #2D2D2D; }
        #preview-image-wrapper { position: relative; display: flex; justify-content: center; align-items: center; max-width:100%; max-height:100%;}
        #preview-image { max-width: 100%; max-height: 100%; border-radius: 20px; object-fit: contain; }
        .meme-text { position: absolute; width: 100%; text-align: center; padding: 0 10px; font-family: 'Impact', sans-serif; font-size: 2rem; color: white; -webkit-text-stroke: 1px black; text-transform: uppercase; pointer-events: none; }
        #top-text { top: 10px; }
        #bottom-text { bottom: 10px; }
        .placeholder { text-align: center; color: #A0A0A0; font-size: 1rem; font-weight: 500; transition: opacity 0.3s; }
        .dark .placeholder { color: #888; }
        .bottom-bar { width: 100%; background-color: #FDFDFC; border-top: 1px solid #E5E5E5; padding: 12px 0; display: flex; justify-content: space-around; align-items: center; transition: background-color 0.3s, border-color 0.3s; z-index: 5; }
        .dark .bottom-bar { background-color: #1E1E1E; border-top-color: #333; }
        .bottom-bar .nav-item { display: flex; flex-direction: column; align-items: center; flex-grow: 1; }
        .bottom-bar button:not(#prompt-btn) { display: flex; flex-direction: column; align-items: center; color: #A0A0A0; font-size: 0.75rem; font-weight: 500; padding: 0; width: 64px; height: 56px; justify-content: center; border-radius: 8px; transition: all 0.2s ease-in-out; background: none; border: none; cursor:pointer; }
        .dark .bottom-bar button:not(#prompt-btn) { color: #888; }
        .bottom-bar button.active { color: #000000; }
        .dark .bottom-bar button.active { color: #FFFFFF; }
        .bottom-bar button:disabled { opacity: 0.5; cursor: not-allowed; }
        #prompt-btn-wrapper { flex-shrink: 0; display: flex; flex-direction: column; align-items: center;}
        #prompt-btn { width: 64px; height: 64px; background-color: #000000; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-top: -30px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: background-color 0.3s, transform 0.1s; position: relative; padding: 0; border:none; cursor:pointer;}
        #prompt-btn-caption { font-size: 0.75rem; font-weight: 500; margin-top: 4px; color: #A0A0A0; pointer-events: none;}
        .dark #prompt-btn-caption { color: #888; }
        .dark #prompt-btn { background-color: #333; }
        .bottom-bar button:active, #prompt-btn:active { transform: scale(0.95); }
        .section-container, .studio-container { width: 100%; max-height: 45%; background-color: #FDFDFC; padding: 16px 24px; box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1); position: absolute; bottom: -100%; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 10; display: flex; flex-direction: column; overflow-y: hidden; }
        .dark .section-container, .dark .studio-container { background-color: #1E1E1E; box-shadow: 0 -4px 6px -1px rgb(255 255 255 / 0.1), 0 -2px 4px -2px rgb(255 255 255 / 0.1); }
        .section-container.open, .studio-container.open { bottom: 0; }
        .no-transition { transition: none !important; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0;}
        .section-content { overflow-y: auto; display: flex; flex-wrap: wrap; gap: 12px; padding-bottom: 12px; justify-content: flex-start;}
        .section-content button { background: none; border: none; cursor: pointer; }
        .section-content::-webkit-scrollbar { display: none; }
        .tool-button { display: flex; flex-direction: column; align-items: center; width: 70px; text-align: center; position: relative; transition: transform 0.1s; }
        .tool-button:active { transform: scale(0.95); }
        .tool-icon { width: 56px; height: 56px; background-color: #EFEFEF; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; margin-bottom: 4px; }
        .dark .tool-icon { background-color: #2D2D2D; }
        .tool-label { font-size: 0.75rem; color: #606060; font-weight: 500; }
        .dark .tool-label { color: #A0A0A0; }
        .pro-badge { position: absolute; top: 0; right: 0; background-color: var(--pro-color); color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 5px; border-radius: 5px; }
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 50; }
        .modal { width: 100%; max-height: 90%; background-color: #FDFDFC; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 24px; transform: translateY(100%); transition: transform 0.3s ease-in-out; position: absolute; bottom: 0; display: flex; flex-direction: column; }
        .dark .modal { background-color: #1E1E1E; }
        .modal.open { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-content { width: 100%; flex: 1; overflow-y: auto; }
        #prompt-input { width: 100%; min-height: 80px; padding: 12px; border-radius: 12px; border: 1px solid #E5E5E5; resize: vertical; font-size: 1rem; color: #333; outline: none; transition: border-color 0.2s; background-color: #FDFDFC; }
        .dark #prompt-input { background-color: #2D2D2D; border-color: #333; color: #FDFDFC; }
        #prompt-input:focus { border-color: #000000; }
        .dark #prompt-input:focus { border-color: #A0A0A0; }
        .message-box { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 12px 24px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.3s; font-size: 0.9rem; pointer-events: none; }
        .loader-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:40; border-radius:20px; backdrop-filter: blur(5px); }
        .loader-logo { font-size: 3rem; font-weight: bold; animation: pulse 1.5s infinite ease-in-out; }
        #loading-text { margin-top: 1rem; color: white; font-weight: 500; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }
        .top-bar button { background-color: transparent; border: none; padding: 6px 12px; border-radius: 9999px; transition: background-color 0.2s, color 0.2s, transform 0.1s; cursor: pointer; }
        .top-bar button:active { transform: scale(0.95); }
        .top-bar button:hover { background-color: rgba(0, 0, 0, 0.05); }
        .dark .top-bar button:hover { background-color: rgba(255, 255, 255, 0.05); }
        .top-bar button:disabled { color: rgba(0, 0, 0, 0.3); }
        .dark .top-bar button:disabled { color: rgba(255, 255, 255, 0.3); }
        .top-bar svg { color: #A0A0A0; stroke-width: 1.5; transition: color 0.2s; }
        .dark .top-bar svg { color: #888; }
        .top-bar button:hover svg { color: #000000; }
        .dark .top-bar button:hover svg { color: #FFFFFF; }
        .top-bar button:disabled svg { color: rgba(0, 0, 0, 0.3) !important; }
        .dark .top-bar button:disabled svg { color: rgba(255, 255, 255, 0.3) !important; }
        .mockup-upload-box { border: 2px dashed #D1D5DB; background-color: #F9FAFB; }
        .dark .mockup-upload-box { border-color: #4B5563; background-color: #374151; }
        .mockup-upload-box img { max-height: 80px; }
    </style>
    <script src="capacitor.js"></script>
</head>
<body class="dark">
    <div class="app-container">
        <!-- Onboarding & Subscription Modals -->
        <div id="onboarding-modal-overlay" class="modal-overlay">
            <div id="onboarding-modal" class="modal"><div id="onboarding-welcome-screen" class="modal-content flex flex-col items-center justify-center text-center"><h2 class="text-3xl font-bold mb-4">Welcome to Blend</h2><p class="text-gray-600 dark:text-gray-400 mb-6">Your AI-powered creative studio for precision editing.</p><button onclick="showSubscriptionScreen()" class="w-full bg-black text-white py-3 rounded-xl font-semibold dark:bg-gray-700 dark:text-gray-100">Let's Get Started</button><p onclick="closeOnboarding()" class="mt-4 text-sm text-gray-500 hover:underline cursor-pointer">Continue without account</p></div></div>
        </div>
        <div id="subscription-modal-overlay" class="modal-overlay">
            <div id="subscription-modal" class="modal">
                <div class="modal-header"><h3 class="text-2xl font-bold">Go Pro</h3><button onclick="toggleSubscriptionModal()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
                <div class="modal-content space-y-4">
                    <div class="p-4 border rounded-lg text-center bg-indigo-50 dark:bg-gray-700 border-indigo-200 dark:border-gray-600"><h4 class="font-bold text-lg">7-Day Free Trial</h4><p class="text-sm">Then $9.99/month. Cancel anytime.</p></div>
                    <div class="space-y-2">
                        <p class="font-semibold">Unlock all Pro features:</p>
                        <ul class="list-disc list-inside text-sm space-y-1"><li>AI Relight & Sky Replace</li><li>Advanced Portrait Retouch</li><li>4x AI Upscaling</li><li>Custom LUT Import/Export</li><li>Batch Processing</li><li>Ad-free experience</li></ul>
                    </div>
                    <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold" onclick="subscribe('pro')">Start Free Trial & Subscribe</button>
                    <button class="w-full text-center text-sm text-gray-500" onclick="showMessage('Purchase restored!')">Restore Purchase</button>
                </div>
            </div>
        </div>

        <!-- Top Bar -->
        <div class="top-bar"><h1 class="logo">blend</h1><div class="flex items-center space-x-2"><button id="undo-btn"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8a5 5 0 015 5v0a5 5 0 01-5 5H6" /></svg></button><button id="redo-btn"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 15l3-3m0 0l-3-3m3 3H8a5 5 0 00-5 5v0a5 5 0 005 5h8" /></svg></button></div></div>
        <div id="message-box" class="message-box"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <input type="file" id="file-input" class="hidden" accept="image/*">
            <div id="image-upload-container" class="image-container">
                <div id="loader-overlay" class="loader-overlay hidden"><div class="loader-logo">B</div><p id="loading-text"></p></div>
                <div id="preview-image-wrapper"><img id="preview-image" src="" alt="Preview" class="hidden"><div id="top-text" class="meme-text"></div><div id="bottom-text" class="meme-text"></div></div>
                <div id="placeholder-text" class="placeholder">Tap to upload or use Prompt</div>
            </div>
        </div>

        <!-- Panels -->
        <div id="templates-section" class="section-container"><div class="section-header"><h3 class="text-lg font-semibold">Templates</h3><button onclick="closeSection()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="section-content"><h4 class="w-full font-bold text-sm mb--2">Use Cases</h4><button class="tool-button" onclick="handleAIAction('a professional LinkedIn profile picture, clean background')"><div class="tool-icon">üëî</div><span class="tool-label">LinkedIn</span></button><button class="tool-button" onclick="handleAIAction('an eCommerce product shot, minimalist')"><div class="tool-icon">üõçÔ∏è</div><span class="tool-label">eCommerce</span></button><button class="tool-button" onclick="handleProFeatureClick('Magic Avatar')"><div class="tool-icon">üé≠</div><span class="tool-label">Magic Avatar</span><div class="pro-badge">Pro</div></button><button class="tool-button" onclick="toggleMockupModal()"><div class="tool-icon">üñºÔ∏è</div><span class="tool-label">Mockups</span></button><button class="tool-button" onclick="handleAIAction('frame the image in a classic polaroid picture')"><div class="tool-icon">üì∏</div><span class="tool-label">Polaroid</span></button></div></div>
        <div id="styles-section" class="section-container"><div class="section-header"><h3 class="text-lg font-semibold">Styles</h3><button onclick="closeSection()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="section-content"><h4 class="w-full font-bold text-sm mt-4 mb--2">Viral Presets</h4><button class="tool-button" onclick="handleAIAction('in the style of Film Soft with soft contrast')"><div class="tool-icon">üéûÔ∏è</div><span class="tool-label">Film Soft</span></button><button class="tool-button" onclick="handleAIAction('with a Clean Studio look and crisp micro-contrast')"><div class="tool-icon">üí°</div><span class="tool-label">Clean Studio</span></button><button class="tool-button" onclick="handleAIAction('with a Y2K Flashcore vibe, direct flash look')"><div class="tool-icon">üì∏</div><span class="tool-label">Y2K Flash</span></button><button class="tool-button" onclick="handleAIAction('in a Moody Blue Hour style with cool shadows')"><div class="tool-icon">üåô</div><span class="tool-label">Blue Hour</span></button><button class="tool-button" onclick="handleAIAction('with muted greens and warm skin tones')"><div class="tool-icon">üåø</div><span class="tool-label">Muted Greens</span></button><button class="tool-button" onclick="handleAIAction('with a warm golden hour glow')"><div class="tool-icon">‚òÄÔ∏è</div><span class="tool-label">Golden Hour</span></button><button class="tool-button" onclick="handleAIAction('a high-contrast black and white noir style')"><div class="tool-icon">‚ö´</div><span class="tool-label">Noir</span></button><button class="tool-button" onclick="handleAIAction('with vibrant, saturated colors')"><div class="tool-icon">üé®</div><span class="tool-label">Vibrant</span></button></div></div>
        <div id="magic-section" class="section-container"><div class="section-header"><h3 class="text-lg font-semibold">Magic Tools</h3><button onclick="closeSection()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="section-content"><button class="tool-button" onclick="handleAIAction('magic erase the main subject')"><div class="tool-icon">ü™Ñ</div><span class="tool-label">Magic Erase</span></button><button class="tool-button" onclick="handleAIAction('replace the background')"><div class="tool-icon">üîÑ</div><span class="tool-label">Replace BG</span></button><button class="tool-button" onclick="handleAIAction('upscale the image 2x')"><div class="tool-icon">üîç</div><span class="tool-label">Upscale</span></button><button class="tool-button" onclick="handleProFeatureClick('Relight')"><div class="tool-icon">üí°</div><span class="tool-label">Relight</span><div class="pro-badge">Pro</div></button><button class="tool-button" onclick="handleProFeatureClick('Sky Replace')"><div class="tool-icon">üèûÔ∏è</div><span class="tool-label">Sky Replace</span><div class="pro-badge">Pro</div></button><button class="tool-button" onclick="handleProFeatureClick('Portrait Retouch')"><div class="tool-icon">üòä</div><span class="tool-label">Retouch</span><div class="pro-badge">Pro</div></button><button class="tool-button" onclick="handleAIAction('apply sharpening and enhance structure')"><div class="tool-icon">‚ú®</div><span class="tool-label">Sharpen</span></button><button class="tool-button" onclick="handleProFeatureClick('Dehaze')"><div class="tool-icon">üí®</div><span class="tool-label">Dehaze</span><div class="pro-badge">Pro</div></button><button class="tool-button" onclick="handleProFeatureClick('Halation')"><div class="tool-icon">üåü</div><span class="tool-label">Halation</span><div class="pro-badge">Pro</div></button></div></div>
        <div id="account-section" class="section-container"><div class="section-header"><h3 class="text-lg font-semibold">Account</h3><button onclick="closeSection()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="section-content"><button class="tool-button" onclick="toggleSubscriptionModal()"><div class="tool-icon">üíé</div><span class="tool-label">Subscription</span></button><button id="theme-toggle-btn" class="tool-button"><div class="tool-icon">üåó</div><span class="tool-label">Theme</span></button><button class="tool-button" onclick="logout()"><div class="tool-icon">üö™</div><span class="tool-label">Logout</span></button></div></div>
        <div id="studio-section" class="studio-container"><div class="section-header"><h3 class="text-lg font-semibold">Studio</h3><button onclick="closeStudio()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="section-content"><button id="add-text-btn" class="tool-button"><div class="tool-icon">üìù</div><span class="tool-label">Add Text</span></button><button id="export-btn" class="tool-button"><div class="tool-icon">üíæ</div><span class="tool-label">Export</span></button><button id="captions-btn" class="tool-button"><div class="tool-icon">‚ú®</div><span class="tool-label">Captions</span></button></div></div>
        
        <!-- Action Modals -->
        <div id="prompt-modal-overlay" class="modal-overlay"><div id="prompt-modal" class="modal"><div class="modal-header"><h3 class="text-lg font-semibold">Prompt Autopilot</h3><button onclick="togglePromptModal()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="modal-content flex flex-col"><p class="text-sm text-gray-500 mb-2">Describe an edit or a new creation. Our AI will handle the rest.</p><textarea id="prompt-input" class="flex-1" placeholder="e.g., An astronaut on a horse on Mars..."></textarea><div class="mt-4"><button id="generate-button" class="w-full bg-black text-white py-3 rounded-xl font-semibold dark:bg-gray-700">Generate</button></div></div></div></div>
        <div id="meme-modal-overlay" class="modal-overlay"><div id="meme-modal" class="modal"><div class="modal-header"><h3 class="text-lg font-semibold">Meme Generator</h3><button onclick="toggleMemeModal()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="modal-content flex flex-col gap-4"><input id="top-text-input" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600" placeholder="Top Text"><input id="bottom-text-input" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600" placeholder="Bottom Text"><div class="flex space-x-2"><button id="apply-meme-text-btn" class="w-full bg-black text-white py-2 rounded dark:bg-gray-700">Apply</button><button id="suggest-meme-btn" class="w-full bg-gray-200 text-black dark:bg-gray-600 dark:text-white py-2 rounded">Suggest ‚ú®</button></div></div></div></div>
        <div id="export-modal-overlay" class="modal-overlay"><div id="export-modal" class="modal"><div class="modal-header"><h3 class="text-lg font-semibold">Export Image</h3><button onclick="toggleExportModal()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="modal-content grid grid-cols-2 gap-4"><button onclick="exportImage('png')" class="p-4 border rounded dark:border-gray-600">PNG</button><button onclick="exportImage('jpeg')" class="p-4 border rounded dark:border-gray-600">JPG</button><button onclick="exportImage('instagram_post')" class="p-4 border rounded dark:border-gray-600">Post (1:1)</button><button onclick="exportImage('instagram_story')" class="p-4 border rounded dark:border-gray-600">Story (9:16)</button></div></div></div>
        <div id="captions-modal-overlay" class="modal-overlay"><div id="captions-modal" class="modal"><div class="modal-header"><h3 class="text-lg font-semibold">AI Captions ‚ú®</h3><button onclick="toggleCaptionsModal()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div id="captions-content" class="modal-content space-y-3"></div></div></div>
        <div id="mockup-modal-overlay" class="modal-overlay"><div id="mockup-modal" class="modal"><div class="modal-header"><h3 class="text-lg font-semibold">Mockup Generator</h3><button onclick="toggleMockupModal()"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="modal-content flex flex-col gap-4"><div class="grid grid-cols-2 gap-4"><div id="mockup-object-upload" class="mockup-upload-box p-4 rounded-lg flex flex-col items-center justify-center cursor-pointer"><input type="file" id="mockup-object-input" class="hidden" accept="image/*"><img id="mockup-object-preview" src="" class="hidden mb-2 rounded"><span id="mockup-object-text">Upload Object</span></div><div id="mockup-scene-upload" class="mockup-upload-box p-4 rounded-lg flex flex-col items-center justify-center cursor-pointer"><input type="file" id="mockup-scene-input" class="hidden" accept="image/*"><img id="mockup-scene-preview" src="" class="hidden mb-2 rounded"><span id="mockup-scene-text">Upload Scene</span></div></div><button id="generate-mockup-btn" class="w-full bg-black text-white py-3 rounded-xl font-semibold dark:bg-gray-700" disabled>Generate</button></div></div></div>

        <!-- Bottom Bar -->
        <div class="bottom-bar">
            <div class="nav-item"><button id="templates-btn"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>Templates</button></div>
            <div class="nav-item"><button id="styles-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12.5" /></svg>Styles</button></div>
            <div class="nav-item" id="prompt-btn-wrapper">
                <button id="prompt-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg></button>
                <span id="prompt-btn-caption">Prompt</span>
            </div>
            <div class="nav-item"><button id="magic-btn"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17.67l-2.06-2.06a2.25 2.25 0 010-3.18l5.25-5.25a2.25 2.25 0 013.18 0l2.06 2.06a2.25 2.25 0 010 3.18l-5.25 5.25a2.25 2.25 0 01-3.18 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 5.25l6.75 6.75" /></svg>Magic</button></div>
            <div class="nav-item"><button id="account-btn"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>Account</button></div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- DOM Elements ---
    const onboardingModalOverlay = document.getElementById('onboarding-modal-overlay');
    const onboardingModal = document.getElementById('onboarding-modal');
    const subscriptionModalOverlay = document.getElementById('subscription-modal-overlay');
    const imageUploadContainer = document.getElementById('image-upload-container');
    const fileInput = document.getElementById('file-input');
    const previewImage = document.getElementById('preview-image');
    const placeholderText = document.getElementById('placeholder-text');
    const loaderOverlay = document.getElementById('loader-overlay');
    const loadingText = document.getElementById('loading-text');
    const messageBox = document.getElementById('message-box');
    const navButtons = { templates: document.getElementById('templates-btn'), styles: document.getElementById('styles-btn'), magic: document.getElementById('magic-btn'), account: document.getElementById('account-btn') };
    const sections = { templates: document.getElementById('templates-section'), styles: document.getElementById('styles-section'), magic: document.getElementById('magic-section'), account: document.getElementById('account-section') };
    const studioSection = document.getElementById('studio-section');
    const promptBtn = document.getElementById('prompt-btn');
    const promptModalOverlay = document.getElementById('prompt-modal-overlay');
    const promptModal = document.getElementById('prompt-modal');
    const promptInput = document.getElementById('prompt-input');
    const generateButton = document.getElementById('generate-button');
    const undoBtn = document.getElementById('undo-btn');
    const redoBtn = document.getElementById('redo-btn');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const memeModalOverlay = document.getElementById('meme-modal-overlay');
    const memeModal = document.getElementById('meme-modal');
    const topTextInput = document.getElementById('top-text-input');
    const bottomTextInput = document.getElementById('bottom-text-input');
    const applyMemeTextBtn = document.getElementById('apply-meme-text-btn');
    const suggestMemeBtn = document.getElementById('suggest-meme-btn');
    const topText = document.getElementById('top-text');
    const bottomText = document.getElementById('bottom-text');
    const exportModalOverlay = document.getElementById('export-modal-overlay');
    const captionsModalOverlay = document.getElementById('captions-modal-overlay');
    const captionsModal = document.getElementById('captions-modal');
    const captionsContent = document.getElementById('captions-content');
    const addTextBtn = document.getElementById('add-text-btn');
    const exportBtn = document.getElementById('export-btn');
    const captionsBtn = document.getElementById('captions-btn');
    const mockupModalOverlay = document.getElementById('mockup-modal-overlay');
    const mockupModal = document.getElementById('mockup-modal');
    const mockupObjectInput = document.getElementById('mockup-object-input');
    const mockupSceneInput = document.getElementById('mockup-scene-input');
    const mockupObjectPreview = document.getElementById('mockup-object-preview');
    const mockupScenePreview = document.getElementById('mockup-scene-preview');
    const mockupObjectText = document.getElementById('mockup-object-text');
    const mockupSceneText = document.getElementById('mockup-scene-text');
    const generateMockupBtn = document.getElementById('generate-mockup-btn');

    // --- State ---
    let activeSection = null;
    let imageHistory = [];
    let historyIndex = -1;
    let isGenerating = false;
    let loadingInterval;
    let isProUser = sessionStorage.getItem('isProUser') === 'true';
    let mockupObjectData = null;
    let mockupSceneData = null;

    // --- All Functions ---

    // Core Functions
    window.closeOnboarding = () => { toggleModal(onboardingModalOverlay, onboardingModal); localStorage.setItem('onboardingComplete', 'true'); };
    window.showSubscriptionScreen = () => { closeOnboarding(); toggleSubscriptionModal(); };
    window.subscribe = (tier) => { isProUser = true; sessionStorage.setItem('isProUser', 'true'); showMessage(`Subscribed to ${tier.toUpperCase()}!`); toggleSubscriptionModal(); };
    window.logout = () => { isProUser = false; sessionStorage.removeItem('isProUser'); imageHistory = []; historyIndex = -1; updateUndoRedoButtons(); previewImage.classList.add('hidden'); placeholderText.classList.remove('hidden'); closeAllPanels(); updateNavButtonStates(); showMessage('You have been logged out.'); };
    
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                clearMemeText();
                previewImage.src = e.target.result;
                previewImage.classList.remove('hidden');
                placeholderText.classList.add('hidden');
                updateHistory(e.target.result);
                closeAllPanels();
            };
            reader.readAsDataURL(file);
        }
    }
    
    function updateHistory(imageData) {
        if (historyIndex < imageHistory.length - 1) { imageHistory = imageHistory.slice(0, historyIndex + 1); }
        imageHistory.push(imageData);
        historyIndex = imageHistory.length - 1;
        updateUndoRedoButtons();
        updateNavButtonStates();
    }

    function updateUndoRedoButtons() {
        undoBtn.disabled = historyIndex <= 0;
        redoBtn.disabled = historyIndex >= imageHistory.length - 1;
    }

    function updateNavButtonStates() {
        const needsImage = historyIndex < 0;
        navButtons.templates.disabled = needsImage;
        navButtons.styles.disabled = needsImage;
        navButtons.magic.disabled = needsImage;
    }
    
    window.openSection = (sectionKey) => {
        if (activeSection === sectionKey) { closeSection(); return; }
        closeAllPanels(true);
        activeSection = sectionKey;
        sections[sectionKey].classList.add('open');
        Object.values(navButtons).forEach(btn => btn.classList.remove('active'));
        if(navButtons[sectionKey]) navButtons[sectionKey].classList.add('active');
    };

    window.closeSection = (instant = false) => {
        if (activeSection && sections[activeSection]) {
            if(instant) sections[activeSection].classList.add('no-transition');
            sections[activeSection].classList.remove('open');
            if(navButtons[activeSection]) navButtons[activeSection].classList.remove('active');
            if(instant) setTimeout(() => sections[activeSection].classList.remove('no-transition'), 50);
            activeSection = null;
        }
    };
    
    window.openStudio = () => { if(historyIndex >= 0) studioSection.classList.add('open'); };
    window.closeStudio = (instant = false) => {
        if(instant) studioSection.classList.add('no-transition');
        studioSection.classList.remove('open');
        if(instant) setTimeout(() => studioSection.classList.remove('no-transition'), 50);
    };

    function closeAllPanels(instant = false) { closeSection(instant); closeStudio(instant); }

    // Modals & Gating
    function toggleModal(overlay, modal) {
        const isOpen = overlay.style.display === 'flex';
        if (isOpen) { modal.classList.remove('open'); setTimeout(() => overlay.style.display = 'none', 300); }
        else { overlay.style.display = 'flex'; setTimeout(() => modal.classList.add('open'), 10); }
    }
    window.togglePromptModal = () => toggleModal(promptModalOverlay, promptModal);
    window.toggleMemeModal = () => toggleModal(memeModalOverlay, memeModal);
    window.toggleExportModal = () => toggleModal(exportModalOverlay, document.getElementById('export-modal'));
    window.toggleCaptionsModal = () => toggleModal(captionsModalOverlay, captionsModal);
    window.toggleSubscriptionModal = () => toggleModal(subscriptionModalOverlay, document.getElementById('subscription-modal'));
    window.toggleMockupModal = () => toggleModal(mockupModalOverlay, mockupModal);
    window.handleProFeatureClick = (featureName) => { 
        if(historyIndex < 0) { showMessage("Please upload an image first."); return; }
        if(isProUser) { handleAIAction(`apply ${featureName}`); } 
        else { toggleSubscriptionModal(); } 
    };

    // AI & Generation
    window.handleAIAction = (promptText) => {
        if (historyIndex < 0 && promptText) {
             if(promptText.includes('Magic Avatar')) { initiateGeneration(promptText); return; }
             showMessage("Please upload an image to apply a style or template."); return; 
        }
        initiateGeneration(promptText);
    };
    
    async function initiateGeneration(prompt) {
        if (isGenerating) return;
        const userPrompt = prompt || promptInput.value.trim();
        if (!userPrompt) { showMessage("Please enter a prompt."); return; }
        setLoading(true, "Enhancing prompt...");
        closeAllPanels();
        if (promptModalOverlay.style.display === 'flex') togglePromptModal();
        try {
            const enhancedPrompt = await getEnhancedPrompt(userPrompt);
            setLoading(true, "Generating image...");
            await callImageGenerationAPI(enhancedPrompt);
        } catch (error) {
            console.error("Generation failed:", error);
            showMessage("Something went wrong. Please try again.");
        } finally { setLoading(false); }
    }

    async function getEnhancedPrompt(currentPrompt) {
        const systemPrompt = "You are Blend, a non-destructive, precision-first AI image editor. Your job is to execute the user‚Äôs request exactly. Default to minimal, localized adjustments that satisfy the request, preserving the subject's identity and composition, especially faces. Only switch to wholesale recreation if the user explicitly asks for a new style or regeneration. Interpret the following user request and rephrase it as a concise, expert-level instruction for an AI image model, maintaining fidelity to the original image.";
        const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: currentPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
        try {
            const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) return currentPrompt;
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text.trim() || currentPrompt;
        } catch (error) { return currentPrompt; }
    }

    async function callImageGenerationAPI(finalPrompt, extraImages = []) {
        const hasImage = historyIndex >= 0;
        const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
        const parts = [{ text: finalPrompt }];
        if (hasImage) {
            const base64ImageData = imageHistory[historyIndex].split(',')[1];
            parts.push({ inlineData: { mimeType: "image/png", data: base64ImageData } });
        }
        extraImages.forEach(imgData => {
            parts.push({ inlineData: { mimeType: "image/png", data: imgData.split(',')[1] } });
        });
        const payload = { contents: [{ parts: parts }], generationConfig: { responseModalities: ['IMAGE'] } };
        const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
        const result = await response.json();
        const newBase64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
        if (newBase64Data) {
            const newImageUrl = `data:image/png;base64,${newBase64Data}`;
            previewImage.src = newImageUrl;
            if (!hasImage) {
                placeholderText.classList.add('hidden');
                previewImage.classList.remove('hidden');
            }
            clearMemeText();
            updateHistory(newImageUrl);
            openStudio();
        } else { throw new Error("Couldn't generate image."); }
    }

    async function generateCaptions() {
        if (historyIndex < 0) return;
        captionsContent.innerHTML = '<div class="w-full text-center">Generating...</div>';
        toggleCaptionsModal();
        try {
            const base64ImageData = imageHistory[historyIndex].split(',')[1];
            const systemPrompt = "You are a witty social media expert. Generate 3 creative and engaging captions for the provided image. Respond with ONLY a valid JSON array of strings, like [\"caption 1\", \"caption 2\", \"caption 3\"].";
            const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: "Generate captions for this image." }, { inlineData: { mimeType: "image/png", data: base64ImageData } }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "STRING" } } } };
            const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error('Failed to fetch captions');
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            const captions = JSON.parse(jsonText);
            captionsContent.innerHTML = '';
            captions.forEach(caption => {
                const captionEl = document.createElement('div');
                captionEl.className = "p-3 bg-gray-100 dark:bg-gray-700 rounded-lg flex justify-between items-center";
                captionEl.innerHTML = `<p class="text-sm mr-2">${caption}</p><button class="p-2 rounded-md bg-gray-200 dark:bg-gray-600" onclick="copyToClipboard('${caption.replace(/'/g, "\\'")}')">Copy</button>`;
                captionsContent.appendChild(captionEl);
            });

        } catch (error) {
            console.error("Caption generation failed:", error);
            captionsContent.innerHTML = '<div class="w-full text-center text-red-500">Could not generate captions.</div>';
        }
    }

    async function generateMemeText() {
        if (historyIndex < 0) return;
        const originalText = suggestMemeBtn.innerHTML;
        suggestMemeBtn.innerHTML = 'Thinking...';
        suggestMemeBtn.disabled = true;
        try {
            const base64ImageData = imageHistory[historyIndex].split(',')[1];
            const systemPrompt = "You are a hilarious meme expert. Generate a funny meme caption (top text and bottom text) for the provided image. Respond with ONLY a valid JSON object with two keys: 'top_text' and 'bottom_text'.";
            const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: "Generate meme text for this image." }, { inlineData: { mimeType: "image/png", data: base64ImageData } }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "top_text": { "type": "STRING" }, "bottom_text": { "type": "STRING" } } } } };
            const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error('Failed to fetch meme text');
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            const memeText = JSON.parse(jsonText);
            topTextInput.value = memeText.top_text;
            bottomTextInput.value = memeText.bottom_text;
        } catch (error) {
            console.error("Meme generation failed:", error);
            showMessage("Couldn't generate a meme idea.");
        } finally {
            suggestMemeBtn.innerHTML = originalText;
            suggestMemeBtn.disabled = false;
        }
    }
    
    // Studio & Mockup Features
    function clearMemeText() { topText.innerText = ''; bottomText.innerText = ''; topTextInput.value = ''; bottomTextInput.value = ''; }
    
    window.exportImage = async (format) => {
        const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d'), img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
            let tw = img.naturalWidth, th = img.naturalHeight, sx = 0, sy = 0, sw = img.naturalWidth, sh = img.naturalHeight;
            if (format === 'instagram_post') { tw = th = Math.min(img.naturalWidth, img.naturalHeight); sx = (img.naturalWidth - tw) / 2; sy = (img.naturalHeight - th) / 2; sw = sh = tw; }
            else if (format === 'instagram_story') { tw = img.naturalWidth; th = img.naturalWidth * (16 / 9); if (th > img.naturalHeight) { th = img.naturalHeight; tw = th * (9/16); } sx = (img.naturalWidth - tw) / 2; sy = (img.naturalHeight - th) / 2; sw = tw; sh = th; }
            canvas.width = tw; canvas.height = th;
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, tw, th);
            if (topText.innerText || bottomText.innerText) {
                const fontSize = tw / 15;
                ctx.font = `bold ${fontSize}px Impact`; ctx.fillStyle = 'white'; ctx.strokeStyle = 'black'; ctx.lineWidth = fontSize / 20; ctx.textAlign = 'center';
                if (topText.innerText) { const topY = fontSize * 1.2; ctx.strokeText(topText.innerText, tw / 2, topY); ctx.fillText(topText.innerText, tw / 2, topY); }
                if (bottomText.innerText) { const bottomY = th - (fontSize * 0.4); ctx.strokeText(bottomText.innerText, tw / 2, bottomY); ctx.fillText(bottomText.innerText, tw / 2, bottomY); }
            }
            const link = document.createElement('a'); link.href = canvas.toDataURL(format === 'jpeg' ? 'image/jpeg' : 'image/png', 0.9);
            link.download = `blend_export.${format.split('_')[0]}`; link.click(); toggleExportModal();
        };
        img.src = previewImage.src;
    };
    
    function handleMockupFileUpload(event, type) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'object') {
                    mockupObjectData = e.target.result;
                    mockupObjectPreview.src = mockupObjectData;
                    mockupObjectPreview.classList.remove('hidden');
                    mockupObjectText.classList.add('hidden');
                } else {
                    mockupSceneData = e.target.result;
                    mockupScenePreview.src = mockupSceneData;
                    mockupScenePreview.classList.remove('hidden');
                    mockupSceneText.classList.add('hidden');
                }
                generateMockupBtn.disabled = !(mockupObjectData && mockupSceneData);
            };
            reader.readAsDataURL(file);
        }
    }

    async function initiateMockupGeneration() {
        if (!mockupObjectData || !mockupSceneData) {
            showMessage("Please upload both an object and a scene.");
            return;
        }
        setLoading(true, "Generating Mockup...");
        toggleMockupModal();
        try {
            const prompt = `Place the first image (the object) into the second image (the background scene). Realistically match the lighting, shadows, perspective, and scale to make it look like it's naturally part of the scene. If the object is artwork, frame it appropriately on a wall.`;
            await callImageGenerationAPI(prompt, [mockupObjectData, mockupSceneData]);
        } catch (error) {
            console.error("Mockup generation failed:", error);
            showMessage("Couldn't generate the mockup.");
        } finally {
            setLoading(false);
        }
    }

    // --- UI Utilities ---
    window.copyToClipboard = (text) => {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showMessage('Copied to clipboard!');
        } catch (err) {
            showMessage('Failed to copy.');
        }
        document.body.removeChild(textarea);
    }
    async function performHapticFeedback() {
        try {
            const { Capacitor } = window;
            if (Capacitor && Capacitor.isNativePlatform()) {
                const { Haptics, ImpactStyle } = Capacitor.Plugins;
                await Haptics.impact({ style: ImpactStyle.Light });
            }
        } catch (e) {
            // Silently fail if haptics not available
        }
    }
    function setLoading(isLoading, text = "") {
        isGenerating = isLoading;
        loaderOverlay.classList.toggle('hidden', !isLoading);
        const messages = ["Blending pixels...", "Igniting creativity...", "Summoning AI artists...", "Painting with light...", "Almost there..."];
        if (isLoading) { loadingText.textContent = text; loadingInterval = setInterval(() => { loadingText.textContent = messages[Math.floor(Math.random() * messages.length)]; }, 2000); }
        else { clearInterval(loadingInterval); }
    }
    window.showMessage = (msg) => { messageBox.textContent = msg; messageBox.style.opacity = '1'; setTimeout(() => { messageBox.style.opacity = '0'; }, 3000); };
    async function fetchWithRetry(url, options, retries = 3, delay = 1000) { for (let i = 0; i < retries; i++) { try { return await fetch(url, options); } catch (err) { if (i === retries - 1) throw err; await new Promise(res => setTimeout(res, delay * Math.pow(2, i))); } } }

    // --- Event Listeners & Initializers ---
    if (localStorage.getItem('onboardingComplete') !== 'true') { onboardingModalOverlay.style.display = 'flex'; setTimeout(() => onboardingModal.classList.add('open'), 10); }
    imageUploadContainer.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    undoBtn.addEventListener('click', () => { if (historyIndex > 0) { historyIndex--; clearMemeText(); previewImage.src = imageHistory[historyIndex]; updateUndoRedoButtons(); } });
    redoBtn.addEventListener('click', () => { if (historyIndex < imageHistory.length - 1) { historyIndex++; clearMemeText(); previewImage.src = imageHistory[historyIndex]; updateUndoRedoButtons(); } });
    Object.keys(navButtons).forEach(key => navButtons[key].addEventListener('click', () => {
        performHapticFeedback();
        openSection(key);
    }));
    promptBtn.addEventListener('click', () => {
        performHapticFeedback();
        togglePromptModal();
    });
    generateButton.addEventListener('click', () => {
        performHapticFeedback();
        initiateGeneration();
    });
    addTextBtn.addEventListener('click', toggleMemeModal);
    applyMemeTextBtn.addEventListener('click', () => { topText.innerText = topTextInput.value; bottomText.innerText = bottomTextInput.value; toggleMemeModal(); });
    suggestMemeBtn.addEventListener('click', generateMemeText);
    captionsBtn.addEventListener('click', generateCaptions);
    exportBtn.addEventListener('click', () => {
        performHapticFeedback();
        toggleExportModal();
    });
    themeToggleBtn.addEventListener('click', () => { document.body.classList.toggle('dark'); localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light'); });
    document.getElementById('mockup-object-upload').addEventListener('click', () => mockupObjectInput.click());
    document.getElementById('mockup-scene-upload').addEventListener('click', () => mockupSceneInput.click());
    mockupObjectInput.addEventListener('change', (e) => handleMockupFileUpload(e, 'object'));
    mockupSceneInput.addEventListener('change', (e) => handleMockupFileUpload(e, 'scene'));
    generateMockupBtn.addEventListener('click', initiateMockupGeneration);
    
    updateUndoRedoButtons();
    updateNavButtonStates();
    if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark'); } else { document.body.classList.remove('dark'); }
});
</script>
</body>
</html>

